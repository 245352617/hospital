## 龙岗中心发包流程

### 一、测试环境

1. FileBrowser
   
   > 服务器的 FileBrowser 服务运行在容器中，相关配置文件地址在`/data/szyj/conf/filebrowser/`，上传的文件在 `/data/szyj/packages/`
   
   地址：http://192.168.241.101:3001/
   
   帐号：admin
   
   密码：shangzhe@123

2. 脚本地址

3. docker-compose 地址
   
   /data/szyj/docker-compose.infra.yml

4. 配置文件地址
   
   * ocelot: /data/szyj/conf/ocelot.json
   
   * apisrv: /data/szyj/conf/apisrv.json
   
   * idssrv: /data/szyj/conf/idssrv.json
   
   * portal（nginx）: /data/szyj/conf/nginx/
   - masterdata: /data/szyj/ecis-masterdata/appsettings.json
   
   - triage: /data/szyj/ecis-triage/*
   
   - patient: /data/szyj/ecis-nursing/appsettings.json
   
   - handover: /data/szyj/ecis-handover/appsettings.json
   
   - recipe: /data/szyj/ecis-recipe/appsettings.json
   
   - report: /data/szyj/ecis-report/appsettings.json
   
   - nursing: /data/szyj/ecis-nursing/appsettings.json
   
   - emr: /data/szyj/ecis-emr/appsettings.json
   
   - im: /data/szyj/ecis-im/appsettings.json
   
   - call: /data/szyj/ecis-call/appsettings.json
   
   - ecis-dcwriter: /data/szyj/ecis-dcwriter/appsettings.json

5. 统一配置中心（暂无）

### 二、发包步骤



### 三、正式环境数据库备份

> 数据库服务器（192.168.241.100）

1. 相关脚本
- /home/backupdb.sh 备份数据库（全量备份）

```shell
#!/bin/bash
DATEPATH=$(date "+%Y%m%d")
DATABASE="ECISTriage"
if [ ! -d "/var/log/backupdb" ]; then
        mkdir -p /var/log/backupdb
fi
if [ ! -f "/var/log/backupdb/${DATEPATH}.log" ]; then
        touch "/var/log/backupdb/${DATEPATH}.log"
fi

date "+%Y-%m-%d %H:%H:%S" >> /var/log/backupdb/${DATEPATH}.log
echo "-- Backup $DATABASE to /home/data/mssql/backup/triage_${DATEPATH}.bak" >> /var/log/backupdb/${DATEPATH}.log

docker exec mssql-server /opt/mssql-tools/bin/sqlcmd -S . -U sa -P DBA@samjan.com -Q "Backup Database $DATABASE To Disk='/var/opt/mssql/backup/triage_${DATEPATH}.bak'"
```

- /home/cleanbackup.sh 清理备份（超过14天自动删除）

```shell
find /home/data/mssql/backup/ -ctime +14 -type f -name *.bak -exec rm -f {} \;
```

2. crontab 定时任务

```crontab
0 0 * * * /home/backupdb.sh
0 0 * * * /home/cleanbackup.sh
```

每天0点定时进行全量备份；
每天0点定时执行清理14天之前的备份文件；

3. 备份日志

/var/log/backupdb
